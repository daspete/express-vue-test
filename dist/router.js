'use strict';

var express = require('express'),
    glob = require('glob'),
    logger = require('morgan'),
    cookieParser = require('cookie-parser'),
    bodyParser = require('body-parser'),
    compress = require('compression'),
    methodOverride = require('method-override'),
    cookieSession = require('cookie-session'),
    helmet = require('helmet'),
    csrf = require('csurf'),
    validator = require('express-validator'),
    expressVue = require('express-vue'),
    oauth2Api = require('./api'),
    path = require('path');

module.exports.init = function (app, config) {
    //Setup
    var env = process.env.NODE_ENV || 'development';
    var router = express.Router();
    var logType = 'dev';
    app.locals.ENV = env;
    app.locals.ENV_DEVELOPMENT = env === 'development';
    app.locals.rootPath = process.env.ROOT_PATH;

    var expressVueMiddleware = expressVue.init(config.vueOptions);
    app.use(expressVueMiddleware);

    //Security
    app.use(helmet());
    app.disable('x-powered-by');

    //Api
    var oauth2 = oauth2Api.init();
    app.use('/oauth2', oauth2);

    app.use(bodyParser.json());
    app.use(bodyParser.urlencoded({
        extended: true
    }));
    app.use(validator());

    app.use(compress());

    app.use(app.locals.rootPath, express.static(config.root));

    var sessionConfig = config.session;

    if (env === 'production') {
        app.set('trust proxy', 1);
        sessionConfig.cookie.secure = true;
        logType = 'combined';
    }

    if (env === 'development') {
        app.use(logger(logType));
    }

    app.use(cookieParser());

    app.use(methodOverride());

    app.use(cookieSession(sessionConfig));

    app.use(csrf({
        cookie: true
    }));

    app.use(function (req, res, next) {
        res.cookie('token', req.csrfToken(), {
            path: '/'
        });
        next();
    });

    app.use('/', router);

    var controllers = glob.sync(config.root + '/routes/**/*.js');
    controllers.forEach(function (controller) {
        module.require(controller).default(router);
    });

    app.use(function (req, res) {
        var data = {
            title: 'Error 404'
        };
        var vueOptions = {
            head: {
                title: 'Error 404'
            }
        };
        res.statusCode = 404;
        res.renderVue('error', data, vueOptions);
    });

    app.use(function onError(error, req, res, next) {
        res.statusCode = 500;
        var data = {
            debug: env === 'development',
            errorCode: error.code,
            error: error.stack
        };
        if (res.statusCode) {
            res.renderVue('error', data);
        } else {
            next();
        }
    });
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJvdXRlci5qcyJdLCJuYW1lcyI6WyJleHByZXNzIiwicmVxdWlyZSIsImdsb2IiLCJsb2dnZXIiLCJjb29raWVQYXJzZXIiLCJib2R5UGFyc2VyIiwiY29tcHJlc3MiLCJtZXRob2RPdmVycmlkZSIsImNvb2tpZVNlc3Npb24iLCJoZWxtZXQiLCJjc3JmIiwidmFsaWRhdG9yIiwiZXhwcmVzc1Z1ZSIsIm9hdXRoMkFwaSIsInBhdGgiLCJtb2R1bGUiLCJleHBvcnRzIiwiaW5pdCIsImFwcCIsImNvbmZpZyIsImVudiIsInByb2Nlc3MiLCJOT0RFX0VOViIsInJvdXRlciIsIlJvdXRlciIsImxvZ1R5cGUiLCJsb2NhbHMiLCJFTlYiLCJFTlZfREVWRUxPUE1FTlQiLCJyb290UGF0aCIsIlJPT1RfUEFUSCIsImV4cHJlc3NWdWVNaWRkbGV3YXJlIiwidnVlT3B0aW9ucyIsInVzZSIsImRpc2FibGUiLCJvYXV0aDIiLCJqc29uIiwidXJsZW5jb2RlZCIsImV4dGVuZGVkIiwic3RhdGljIiwicm9vdCIsInNlc3Npb25Db25maWciLCJzZXNzaW9uIiwic2V0IiwiY29va2llIiwic2VjdXJlIiwicmVxIiwicmVzIiwibmV4dCIsImNzcmZUb2tlbiIsImNvbnRyb2xsZXJzIiwic3luYyIsImZvckVhY2giLCJjb250cm9sbGVyIiwiZGVmYXVsdCIsImRhdGEiLCJ0aXRsZSIsImhlYWQiLCJzdGF0dXNDb2RlIiwicmVuZGVyVnVlIiwib25FcnJvciIsImVycm9yIiwiZGVidWciLCJlcnJvckNvZGUiLCJjb2RlIiwic3RhY2siXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFDSUEsVUFBVUMsUUFBUSxTQUFSLENBRGQ7QUFBQSxJQUVJQyxPQUFPRCxRQUFRLE1BQVIsQ0FGWDtBQUFBLElBR0lFLFNBQVNGLFFBQVEsUUFBUixDQUhiO0FBQUEsSUFJSUcsZUFBZUgsUUFBUSxlQUFSLENBSm5CO0FBQUEsSUFLSUksYUFBYUosUUFBUSxhQUFSLENBTGpCO0FBQUEsSUFNSUssV0FB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LE9BQVosQ0FBb0IsVUFBU0MsVUFBVCxFQUFvQjtBQUNwQ3RDLGVBQU9kLE9BQVAsQ0FBZW9ELFVBQWYsRUFBMkJDLE9BQTNCLENBQW1DL0IsTUFBbkM7QUFDSCxLQUZEOztBQUlBTCxRQUFJZSxHQUFKLENBQVEsVUFBQ2EsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDbEIsWUFBTVEsT0FBTztBQUNUQyxtQkFBTztBQURFLFNBQWI7QUFHQSxZQUFNeEIsYUFBYTtBQUNmeUIsa0JBQU07QUFDRkQsdUJBQU87QUFETDtBQURTLFNBQW5CO0FBS0FULFlBQUlXLFVBQUosR0FBaUIsR0FBakI7QUFDQVgsWUFBSVksU0FBSixDQUFjLE9BQWQsRUFBdUJKLElBQXZCLEVBQTZCdkIsVUFBN0I7QUFDSCxLQVhEOztBQWFBZCxRQUFJZSxHQUFKLENBQVEsU0FBUzJCLE9BQVQsQ0FBaUJDLEtBQWpCLEVBQXdCZixHQUF4QixFQUE2QkMsR0FBN0IsRUFBa0NDLElBQWxDLEVBQXdDO0FBQzVDRCxZQUFJVyxVQUFKLEdBQWlCLEdBQWpCO0FBQ0EsWUFBSUgsT0FBTztBQUNQTyxtQkFBTzFDLFFBQVEsYUFEUjtBQUVQMkMsdUJBQVdGLE1BQU1HLElBRlY7QUFHUEgsbUJBQU9BLE1BQU1JO0FBSE4sU0FBWDtBQUtBLFlBQUlsQixJQUFJVyxVQUFSLEVBQW9CO0FBQ2hCWCxnQkFBSVksU0FBSixDQUFjLE9BQWQsRUFBdUJKLElBQXZCO0FBQ0gsU0FGRCxNQUVPO0FBQ0hQO0FBQ0g7QUFDSixLQVpEO0FBY0gsQ0E3RkQiLCJmaWxlIjoicm91dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgXHJcbiAgICBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpLFxyXG4gICAgZ2xvYiA9IHJlcXVpcmUoJ2dsb2InKSxcclxuICAgIGxvZ2dlciA9IHJlcXVpcmUoJ21vcmdhbicpLFxyXG4gICAgY29va2llUGFyc2VyID0gcmVxdWlyZSgnY29va2llLXBhcnNlcicpLFxyXG4gICAgYm9keVBhcnNlciA9IHJlcXVpcmUoJ2JvZHktcGFyc2VyJyksXHJcbiAgICBjb21wcmVzcyA9IHJlcXVpcmUoJ2NvbXByZXNzaW9uJyksXHJcbiAgICBtZXRob2RPdmVycmlkZSA9IHJlcXVpcmUoJ21ldGhvZC1vdmVycmlkZScpLFxyXG4gICAgY29va2llU2Vzc2lvbiA9IHJlcXVpcmUoJ2Nvb2tpZS1zZXNzaW9uJyksXHJcbiAgICBoZWxtZXQgPSByZXF1aXJlKCdoZWxtZXQnKSxcclxuICAgIGNzcmYgPSByZXF1aXJlKCdjc3VyZicpLFxyXG4gICAgdmFsaWRhdG9yID0gcmVxdWlyZSgnZXhwcmVzcy12YWxpZGF0b3InKSxcclxuICAgIGV4cHJlc3NWdWUgPSByZXF1aXJlKCdleHByZXNzLXZ1ZScpLFxyXG4gICAgb2F1dGgyQXBpID0gcmVxdWlyZSgnLi9hcGknKSxcclxuICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcblxyXG5tb2R1bGUuZXhwb3J0cy5pbml0ID0gKGFwcCwgY29uZmlnKSA9PiB7XHJcbiAgICAvL1NldHVwXHJcbiAgICBjb25zdCBlbnYgPSBwcm9jZXNzLmVudi5OT0RFX0VOViB8fCAnZGV2ZWxvcG1lbnQnO1xyXG4gICAgY29uc3Qgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcclxuICAgIGxldCBsb2dUeXBlID0gJ2Rldic7XHJcbiAgICBhcHAubG9jYWxzLkVOViA9IGVudjtcclxuICAgIGFwcC5sb2NhbHMuRU5WX0RFVkVMT1BNRU5UID0gKGVudiA9PT0gJ2RldmVsb3BtZW50Jyk7XHJcbiAgICBhcHAubG9jYWxzLnJvb3RQYXRoID0gcHJvY2Vzcy5lbnYuUk9PVF9QQVRIO1xyXG5cclxuICAgIGNvbnN0IGV4cHJlc3NWdWVNaWRkbGV3YXJlID0gZXhwcmVzc1Z1ZS5pbml0KGNvbmZpZy52dWVPcHRpb25zKTtcclxuICAgIGFwcC51c2UoZXhwcmVzc1Z1ZU1pZGRsZXdhcmUpO1xyXG5cclxuICAgIC8vU2VjdXJpdHlcclxuICAgIGFwcC51c2UoaGVsbWV0KCkpO1xyXG4gICAgYXBwLmRpc2FibGUoJ3gtcG93ZXJlZC1ieScpO1xyXG5cclxuICAgIC8vQXBpXHJcbiAgICBjb25zdCBvYXV0aDIgPSBvYXV0aDJBcGkuaW5pdCgpO1xyXG4gICAgYXBwLnVzZSgnL29hdXRoMicsIG9hdXRoMik7XHJcblxyXG4gICAgYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSk7XHJcbiAgICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7XHJcbiAgICAgICAgZXh0ZW5kZWQ6IHRydWVcclxuICAgIH0pKTtcclxuICAgIGFwcC51c2UodmFsaWRhdG9yKCkpO1xyXG5cclxuICAgIGFwcC51c2UoY29tcHJlc3MoKSk7XHJcblxyXG4gICAgYXBwLnVzZShhcHAubG9jYWxzLnJvb3RQYXRoLCBleHByZXNzLnN0YXRpYyhjb25maWcucm9vdCkpO1xyXG5cclxuICAgIGxldCBzZXNzaW9uQ29uZmlnID0gY29uZmlnLnNlc3Npb247XHJcblxyXG4gICAgaWYgKGVudiA9PT0gJ3Byb2R1Y3Rpb24nKSB7XHJcbiAgICAgICAgYXBwLnNldCgndHJ1c3QgcHJveHknLCAxKTtcclxuICAgICAgICBzZXNzaW9uQ29uZmlnLmNvb2tpZS5zZWN1cmUgPSB0cnVlO1xyXG4gICAgICAgIGxvZ1R5cGUgPSAnY29tYmluZWQnO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChlbnYgPT09ICdkZXZlbG9wbWVudCcpIHtcclxuICAgICAgICBhcHAudXNlKGxvZ2dlcihsb2dUeXBlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXBwLnVzZShjb29raWVQYXJzZXIoKSk7XHJcblxyXG4gICAgYXBwLnVzZShtZXRob2RPdmVycmlkZSgpKTtcclxuXHJcbiAgICBhcHAudXNlKGNvb2tpZVNlc3Npb24oc2Vzc2lvbkNvbmZpZykpO1xyXG5cclxuICAgIGFwcC51c2UoY3NyZih7XHJcbiAgICAgICAgY29va2llOiB0cnVlXHJcbiAgICB9KSk7XHJcblxyXG4gICAgYXBwLnVzZShmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcclxuICAgICAgICByZXMuY29va2llKCd0b2tlbicsIHJlcS5jc3JmVG9rZW4oKSwge1xyXG4gICAgICAgICAgICBwYXRoOiAnLydcclxuICAgICAgICB9KTtcclxuICAgICAgICBuZXh0KCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBhcHAudXNlKCcvJywgcm91dGVyKTtcclxuXHJcbiAgICBsZXQgY29udHJvbGxlcnMgPSBnbG9iLnN5bmMoY29uZmlnLnJvb3QgKyAnL3JvdXRlcy8qKi8qLmpzJyk7XHJcbiAgICBjb250cm9sbGVycy5mb3JFYWNoKGZ1bmN0aW9uKGNvbnRyb2xsZXIpe1xyXG4gICAgICAgIG1vZHVsZS5yZXF1aXJlKGNvbnRyb2xsZXIpLmRlZmF1bHQocm91dGVyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGFwcC51c2UoKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICAgICAgdGl0bGU6ICdFcnJvciA0MDQnXHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCB2dWVPcHRpb25zID0ge1xyXG4gICAgICAgICAgICBoZWFkOiB7XHJcbiAgICAgICAgICAgICAgICB0aXRsZTogJ0Vycm9yIDQwNCdcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0MDQ7XHJcbiAgICAgICAgcmVzLnJlbmRlclZ1ZSgnZXJyb3InLCBkYXRhLCB2dWVPcHRpb25zKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGFwcC51c2UoZnVuY3Rpb24gb25FcnJvcihlcnJvciwgcmVxLCByZXMsIG5leHQpIHtcclxuICAgICAgICByZXMuc3RhdHVzQ29kZSA9IDUwMDtcclxuICAgICAgICBsZXQgZGF0YSA9IHtcclxuICAgICAgICAgICAgZGVidWc6IGVudiA9PT0gJ2RldmVsb3BtZW50JyxcclxuICAgICAgICAgICAgZXJyb3JDb2RlOiBlcnJvci5jb2RlLFxyXG4gICAgICAgICAgICBlcnJvcjogZXJyb3Iuc3RhY2tcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSkge1xyXG4gICAgICAgICAgICByZXMucmVuZGVyVnVlKCdlcnJvcicsIGRhdGEpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG5leHQoKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbn07Il19
